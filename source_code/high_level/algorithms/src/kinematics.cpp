#include "kinematics.h"
#include "Eigen/Dense"
#include "Eigen/unsupported/Eigen/MatrixFunctions"
#include <cmath>

Position Kinematics::computeCoMPos(const Joint_Angles_Two_Legs &joint_angles, const Eigen::Matrix3d &rotation_matrix)
{
      // Initialize the center of mass positions
      Position CoM_link1;       // center of mass of the main control assembly + 2 * hip yaw connector + 2 * hip yaw motors
      Position CoM_link2l;      // center of mass of the left hip roll motor + hip roll connector
      Position CoM_link3l;      // center of mass of the left hip pitch motor + hip pitch connector
      Position CoM_link4l;      // center of mass of the left knee pitch motor + knee pitch connector
      Position CoM_link5l;      // center of mass of the left knee pitch connector + ankle pitch motor
      Position CoM_link6l;      // center of mass of the left foot connector
      Position CoM_link2r;      // center of mass of the right hip roll motor + hip roll connector
      Position CoM_link3r;      // center of mass of the right hip pitch motor + hip pitch connector
      Position CoM_link4r;      // center of mass of the right knee pitch motor + knee pitch connector
      Position CoM_link5r;      // center of mass of the right pitch connector + ankle pitch motor
      Position CoM_link6r;      // center of mass of the right foot connector
      Position CoM_body_frame;  // center of mass of the robot in the body frame
      Position CoM_world_frame; // center of mass of the robot in the world frame

      // Compute the CoM of center part
      CoM_link1.x = C1.x;
      CoM_link1.y = C1.y;
      CoM_link1.z = C1.z;

      // Compute the center of mass of the left leg parts
      CoM_link2l.x = C2.x * cos(joint_angles.left.hip_yaw) - L1 + C2.y * sin(joint_angles.left.hip_yaw);
      CoM_link2l.y = C2.y * cos(joint_angles.left.hip_yaw) - C2.x * sin(joint_angles.left.hip_yaw);
      CoM_link2l.z = C2.z;

      CoM_link3l.x = C3.y * sin(joint_angles.left.hip_yaw) - L1 - L3 * sin(joint_angles.left.hip_yaw) + C3.x * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_roll) + C3.z * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll);
      CoM_link3l.y = C3.y * cos(joint_angles.left.hip_yaw) - L3 * cos(joint_angles.left.hip_yaw) - C3.x * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_yaw) - C3.z * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll);
      CoM_link3l.z = C3.z * cos(joint_angles.left.hip_roll) - L2 - C3.x * sin(joint_angles.left.hip_roll);

      CoM_link4l.x = C4.x * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_roll) - L1 + C4.y * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) - C4.z * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) + C4.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_roll) + C4.y * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch);
      CoM_link4l.y = C4.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) - C4.x * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_yaw) - C4.z * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - C4.z * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) - C4.y * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch);
      CoM_link4l.z = C4.z * cos(joint_angles.left.hip_roll) * cos(joint_angles.left.hip_pitch) - C4.x * sin(joint_angles.left.hip_roll) - L2 + C4.y * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch);

      CoM_link5l.x = C5.x * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_roll) - L1 + L4 * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) + C5.y * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) - L4 * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_roll) - C5.z * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.knee_pitch) - C5.z * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - C5.y * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + C5.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_roll) + C5.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) + C5.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) - C5.z * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch);
      CoM_link5l.y = L4 * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - C5.x * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_yaw) + C5.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) - C5.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) - C5.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_pitch) - C5.y * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + L4 * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) - C5.z * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) - C5.y * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) - C5.y * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) + C5.z * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch);
      CoM_link5l.z = C5.z * cos(joint_angles.left.hip_roll) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) - C5.x * sin(joint_angles.left.hip_roll) - L4 * cos(joint_angles.left.hip_roll) * cos(joint_angles.left.hip_pitch) - L2 + C5.y * cos(joint_angles.left.hip_roll) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + C5.y * cos(joint_angles.left.hip_roll) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_pitch) - C5.z * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch);

      CoM_link6l.x = C6.x * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_roll) - L1 + L4 * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - L4 * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_roll) + L5 * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.knee_pitch) + L5 * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) + C6.y * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) - L5 * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_roll) - C6.z * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.knee_pitch) - C6.z * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - C6.y * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.y * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.ankle_pitch) - C6.y * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + L5 * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + C6.z * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) - C6.y * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) + C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_roll) + C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.ankle_pitch) + C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) + C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch);
      CoM_link6l.y = L4 * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) - C6.x * cos(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_yaw) + L5 * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + L5 * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_pitch) + L4 * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) + C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.knee_pitch) - C6.z * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_pitch) - C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.ankle_pitch) - C6.y * cos(joint_angles.left.hip_yaw) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + L5 * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) + C6.z * cos(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - L5 * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) - C6.y * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.ankle_pitch) - C6.y * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) - C6.y * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) + C6.z * cos(joint_angles.left.hip_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) + C6.z * cos(joint_angles.left.knee_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.ankle_pitch) + C6.z * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) + C6.y * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll) * sin(joint_angles.left.hip_pitch) * sin(joint_angles.left.knee_pitch) * sin(joint_angles.left.ankle_pitch) - C6.z * cos(joint_angles.left.hip_pitch) * cos(joint_angles.left.knee_pitch) * cos(joint_angles.left.ankle_pitch) * sin(joint_angles.left.hip_yaw) * sin(joint_angles.left.hip_roll);
      CoM_link6l.z = (C6.z * cos(joint_angles.left.hip_roll + joint_angles.left.hip_pitch + joint_angles.left.knee_pitch + joint_angles.left.ankle_pitch)) / 2 - (L5 * cos(joint_angles.left.hip_pitch - joint_angles.left.hip_roll + joint_angles.left.knee_pitch)) / 2 - L2 + (C6.y * sin(joint_angles.left.hip_roll + joint_angles.left.hip_pitch + joint_angles.left.knee_pitch + joint_angles.left.ankle_pitch)) / 2 - (L4 * cos(joint_angles.left.hip_roll + joint_angles.left.hip_pitch)) / 2 - C6.x * sin(joint_angles.left.hip_roll) + (C6.z * cos(joint_angles.left.hip_pitch - joint_angles.left.hip_roll + joint_angles.left.knee_pitch + joint_angles.left.ankle_pitch)) / 2 + (C6.y * sin(joint_angles.left.hip_pitch - joint_angles.left.hip_roll + joint_angles.left.knee_pitch + joint_angles.left.ankle_pitch)) / 2 - (L4 * cos(joint_angles.left.hip_roll - joint_angles.left.hip_pitch)) / 2 - (L5 * cos(joint_angles.left.hip_roll + joint_angles.left.hip_pitch + joint_angles.left.knee_pitch)) / 2;

      // Compute the center of mass of the right leg parts
      CoM_link2r.x = L1 - C2.x * cos(joint_angles.right.hip_yaw) + C2.y * sin(joint_angles.right.hip_yaw);
      CoM_link2r.y = C2.y * cos(joint_angles.right.hip_yaw) + C2.x * sin(joint_angles.right.hip_yaw);
      CoM_link2r.z = C2.z;

      CoM_link3r.x = L1 + C3.y * sin(joint_angles.right.hip_yaw) - L3 * sin(joint_angles.right.hip_yaw) + C3.x * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_roll) + C3.z * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll);
      CoM_link3r.y = C3.y * cos(joint_angles.right.hip_yaw) - L3 * cos(joint_angles.right.hip_yaw) - C3.x * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_yaw) - C3.z * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll);
      CoM_link3r.z = C3.z * cos(joint_angles.right.hip_roll) - L2 - C3.x * sin(joint_angles.right.hip_roll);

      CoM_link4r.x = L1 + C4.x * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_roll) + C4.y * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) - C4.z * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) + C4.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_roll) + C4.y * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch);
      CoM_link4r.y = C4.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) - C4.x * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_yaw) - C4.z * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - C4.z * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) - C4.y * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch);
      CoM_link4r.z = C4.z * cos(joint_angles.right.hip_roll) * cos(joint_angles.right.hip_pitch) - C4.x * sin(joint_angles.right.hip_roll) - L2 + C4.y * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch);

      CoM_link5r.x = L1 + C5.x * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_roll) + L4 * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) + C5.y * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) - L4 * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_roll) - C5.z * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.knee_pitch) - C5.z * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - C5.y * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + C5.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_roll) + C5.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) + C5.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) - C5.z * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch);
      CoM_link5r.y = L4 * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - C5.x * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_yaw) + C5.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) - C5.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) - C5.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_pitch) - C5.y * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + L4 * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) - C5.z * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) - C5.y * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) - C5.y * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) + C5.z * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch);
      CoM_link5r.z = C5.z * cos(joint_angles.right.hip_roll) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) - C5.x * sin(joint_angles.right.hip_roll) - L4 * cos(joint_angles.right.hip_roll) * cos(joint_angles.right.hip_pitch) - L2 + C5.y * cos(joint_angles.right.hip_roll) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + C5.y * cos(joint_angles.right.hip_roll) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_pitch) - C5.z * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch);

      CoM_link6r.x = L1 + C6.x * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_roll) + L4 * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - L4 * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_roll) + L5 * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.knee_pitch) + L5 * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) + C6.y * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) - L5 * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_roll) - C6.z * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.knee_pitch) - C6.z * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - C6.y * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.y * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.ankle_pitch) - C6.y * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + L5 * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + C6.z * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) - C6.y * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) + C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_roll) + C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.ankle_pitch) + C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) + C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch);
      CoM_link6r.y = L4 * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) - C6.x * cos(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_yaw) + L5 * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + L5 * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_pitch) + L4 * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) + C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.knee_pitch) - C6.z * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_pitch) - C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.ankle_pitch) - C6.y * cos(joint_angles.right.hip_yaw) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + L5 * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) + C6.z * cos(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - L5 * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) - C6.y * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.ankle_pitch) - C6.y * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) - C6.y * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) + C6.z * cos(joint_angles.right.hip_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) + C6.z * cos(joint_angles.right.knee_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.ankle_pitch) + C6.z * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) + C6.y * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll) * sin(joint_angles.right.hip_pitch) * sin(joint_angles.right.knee_pitch) * sin(joint_angles.right.ankle_pitch) - C6.z * cos(joint_angles.right.hip_pitch) * cos(joint_angles.right.knee_pitch) * cos(joint_angles.right.ankle_pitch) * sin(joint_angles.right.hip_yaw) * sin(joint_angles.right.hip_roll);
      CoM_link6r.z = (C6.z * cos(joint_angles.right.hip_roll + joint_angles.right.hip_pitch + joint_angles.right.knee_pitch + joint_angles.right.ankle_pitch)) / 2 - (L5 * cos(joint_angles.right.hip_pitch - joint_angles.right.hip_roll + joint_angles.right.knee_pitch)) / 2 - L2 + (C6.y * sin(joint_angles.right.hip_roll + joint_angles.right.hip_pitch + joint_angles.right.knee_pitch + joint_angles.right.ankle_pitch)) / 2 - (L4 * cos(joint_angles.right.hip_roll + joint_angles.right.hip_pitch)) / 2 - C6.x * sin(joint_angles.right.hip_roll) + (C6.z * cos(joint_angles.right.hip_pitch - joint_angles.right.hip_roll + joint_angles.right.knee_pitch + joint_angles.right.ankle_pitch)) / 2 + (C6.y * sin(joint_angles.right.hip_pitch - joint_angles.right.hip_roll + joint_angles.right.knee_pitch + joint_angles.right.ankle_pitch)) / 2 - (L4 * cos(joint_angles.right.hip_roll - joint_angles.right.hip_pitch)) / 2 - (L5 * cos(joint_angles.right.hip_roll + joint_angles.right.hip_pitch + joint_angles.right.knee_pitch)) / 2;

      // Compute the center of mass of the robot in the body frame
      CoM_body_frame.x = (CoM_link1.x * M1 + CoM_link2l.x * M2 + CoM_link3l.x * M3 + CoM_link4l.x * M4 + CoM_link5l.x * M5 + CoM_link6l.x * M6 + CoM_link2r.x * M2 + CoM_link3r.x * M3 + CoM_link4r.x * M4 + CoM_link5r.x * M5 + CoM_link6r.x * M6) / MT;
      CoM_body_frame.y = (CoM_link1.y * M1 + CoM_link2l.y * M2 + CoM_link3l.y * M3 + CoM_link4l.y * M4 + CoM_link5l.y * M5 + CoM_link6l.y * M6 + CoM_link2r.y * M2 + CoM_link3r.y * M3 + CoM_link4r.y * M4 + CoM_link5r.y * M5 + CoM_link6r.y * M6) / MT;
      CoM_body_frame.z = (CoM_link1.z * M1 + CoM_link2l.z * M2 + CoM_link3l.z * M3 + CoM_link4l.z * M4 + CoM_link5l.z * M5 + CoM_link6l.z * M6 + CoM_link2r.z * M2 + CoM_link3r.z * M3 + CoM_link4r.z * M4 + CoM_link5r.z * M5 + CoM_link6r.z * M6) / MT;
      Eigen::Vector3d v_CoM_body_frame(CoM_body_frame.x, CoM_body_frame.y, CoM_body_frame.z);

      // Rotate the center of mass of the robot to the world frame
      Eigen::Vector3d v_CoM_world_frame = rotation_matrix * v_CoM_body_frame;
      CoM_world_frame.x = v_CoM_world_frame(0);
      CoM_world_frame.y = v_CoM_world_frame(1);
      CoM_world_frame.z = v_CoM_world_frame(2);

      // Return the center of mass of the robot in the world frame
      return CoM_world_frame;
}

Eigen::Matrix4d Kinematics::computeFootFK(const Joint_Angles &joint_angles, const uint8_t &leg_id)
{
      Eigen::Matrix4d Tbf; // Transformation matrix from base to foot frame computed in MATLAB

      switch (leg_id)
      {
      case LEFT_LEG_ID:
            Tbf << cos(joint_angles.hip_yaw) * cos(joint_angles.hip_roll), cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))), -cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll))), L4 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - L1 - L4 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll) + L5 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.knee_pitch) + L5 * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_roll) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L6 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_roll),
                -cos(joint_angles.hip_roll) * sin(joint_angles.hip_yaw), cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))), -cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll))), L4 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) + L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_pitch) + L4 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) - L6 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) - L5 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) - L6 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) - L6 * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) - L6 * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch),
                -sin(joint_angles.hip_roll), sin(joint_angles.hip_pitch + joint_angles.knee_pitch + joint_angles.ankle_pitch) * cos(joint_angles.hip_roll), cos(joint_angles.hip_pitch + joint_angles.knee_pitch + joint_angles.ankle_pitch) * cos(joint_angles.hip_roll), L5 * cos(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L4 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) - L5 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) - L2 - L6 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch),
                0, 0, 0, 1;
            break;
      case RIGHT_LEG_ID:
            Tbf << cos(joint_angles.hip_yaw) * cos(joint_angles.hip_roll), cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))), -cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) + cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll))), L1 + L4 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - L4 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll) + L5 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.knee_pitch) + L5 * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) - L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_roll) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L6 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_roll),
                -cos(joint_angles.hip_roll) * sin(joint_angles.hip_yaw), cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))), -cos(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll)) + sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch))) - sin(joint_angles.ankle_pitch) * (cos(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) - sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch)) - sin(joint_angles.knee_pitch) * (cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll))), L4 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) + L5 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_pitch) + L4 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.hip_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.hip_yaw) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_pitch) + L5 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) - L6 * cos(joint_angles.hip_yaw) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) - L5 * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) + L6 * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) - L6 * cos(joint_angles.hip_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) - L6 * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) - L6 * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_yaw) * sin(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch),
                -sin(joint_angles.hip_roll), sin(joint_angles.hip_pitch + joint_angles.knee_pitch + joint_angles.ankle_pitch) * cos(joint_angles.hip_roll), cos(joint_angles.hip_pitch + joint_angles.knee_pitch + joint_angles.ankle_pitch) * cos(joint_angles.hip_roll), L5 * cos(joint_angles.hip_roll) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) - L4 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) - L5 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) - L2 - L6 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * cos(joint_angles.knee_pitch) * cos(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.knee_pitch) * sin(joint_angles.hip_pitch) * sin(joint_angles.ankle_pitch) + L6 * cos(joint_angles.hip_roll) * cos(joint_angles.ankle_pitch) * sin(joint_angles.hip_pitch) * sin(joint_angles.knee_pitch),
                0, 0, 0, 1;
            break;
      }

      // Return the transformation matrix from base to foot frame
      return Tbf;
}

Joint_Angles Kinematics::computeFootIK(const Pose &act_foot_pose, const Pose &ref_foot_pose, const Joint_Angles &act_joint_angles, const uint8_t &leg_id)
{
      Eigen::Matrix4d Tbf = pose_to_trans(act_foot_pose); // Transformation matrix from base frame to current foot frame
      Eigen::Matrix4d Tbd = pose_to_trans(ref_foot_pose); // Transformation matrix from base frame to desired foot frame
      Eigen::Matrix4d Tfd = trans_inv(Tbf) * Tbd;         // Transformation matrix from current foot frame to desired foot frame
      Eigen::VectorXd Vf(6);
      Vf = skew_to_twist(Tfd.log()); // Twist vector from current foot frame to desired foot frame
      Eigen::VectorXd Vb(6);
      Vb = trans_to_adj(Tbf) * Vf;          // Twist vector from base frame to desired foot frame
      double epsilon_w = Vb.head(3).norm(); // Error tolerance for angular velocity w
      double epsilon_v = Vb.tail(3).norm(); // Error tolerance for linear velocity v

      iteration_count = 0;                                         // Reset the iteration count
      Joint_Angles computed_joint_angles = {0, 0, 0.3, -0.5, 0.2}; // Initial condition for the joint angles is set so that the knee are bent forward
      Eigen::MatrixXd Jacobian(6, 5);                              // Initialize the Jacobian matrix
      Eigen::VectorXd delta_joint_angles(5);                       // Initialize the change in joint angles
      // Newton-Raphson method for inverse kinematics
      while (epsilon_w > EPSILON_W || epsilon_v > EPSILON_V && iteration_count < MAX_ITERATIONS)
      {
            // Initialize the Jacobian matrix
            switch (leg_id)
            {
            case LEFT_LEG_ID:
                  Jacobian << 0, sin(computed_joint_angles.hip_yaw), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll),
                      0, cos(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw),
                      -1, 0, -sin(computed_joint_angles.hip_roll), -sin(computed_joint_angles.hip_roll), -sin(computed_joint_angles.hip_roll),
                      0, L2 * cos(computed_joint_angles.hip_yaw), -L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw) - L4 * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) - L4 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch), sin(computed_joint_angles.hip_roll) * (sin(computed_joint_angles.hip_yaw) * (L1 * cos(computed_joint_angles.hip_roll) - L1 + L2 * sin(computed_joint_angles.hip_roll)) + L1 * sin(computed_joint_angles.hip_yaw) + (cos(computed_joint_angles.knee_pitch) - 1) * (cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll)) * (L2 + L4) + L2 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) * (L2 + L4) + L2 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * (cos(computed_joint_angles.hip_pitch) - 1)) - (L2 + L4 + L5) * (cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) * sin(computed_joint_angles.hip_yaw) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.knee_pitch) + cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.knee_pitch) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) - cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw) * (L2 + L1 * sin(computed_joint_angles.hip_roll) + L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) - L2 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) - L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) + L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + L4 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch)),
                      -L1, -L2 * sin(computed_joint_angles.hip_yaw), -L1 * sin(computed_joint_angles.hip_roll) - L2 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), L4 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) - L2 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll) - L4 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) - L1 * sin(computed_joint_angles.hip_roll), -(cos(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) - sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll))) * (L2 + L4 + L5) - sin(computed_joint_angles.hip_roll) * (L1 - cos(computed_joint_angles.hip_yaw) * (L1 * cos(computed_joint_angles.hip_roll) - L1 + L2 * sin(computed_joint_angles.hip_roll)) - L1 * cos(computed_joint_angles.hip_yaw) + (cos(computed_joint_angles.knee_pitch) - 1) * (sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) - cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_roll)) * (L2 + L4) + L2 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) + cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) * (L2 + L4) - L2 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * (cos(computed_joint_angles.hip_pitch) - 1)) - cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll) * (L2 + L1 * sin(computed_joint_angles.hip_roll) + L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) - L2 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) - L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) + L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + L4 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch)),
                      0, -L1 * cos(computed_joint_angles.hip_yaw), L1 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), cos(computed_joint_angles.hip_roll) * (L1 * sin(computed_joint_angles.hip_yaw) - L4 * sin(computed_joint_angles.hip_pitch)), -cos(computed_joint_angles.hip_roll) * (L5 * sin(computed_joint_angles.hip_pitch + computed_joint_angles.knee_pitch) - L1 * sin(computed_joint_angles.hip_yaw) + L4 * sin(computed_joint_angles.hip_pitch));
                  break;
            case RIGHT_LEG_ID:
                  Jacobian << 0, sin(computed_joint_angles.hip_yaw), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll),
                      0, cos(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw),
                      -1, 0, -sin(computed_joint_angles.hip_roll), -sin(computed_joint_angles.hip_roll), -sin(computed_joint_angles.hip_roll),
                      0, L2 * cos(computed_joint_angles.hip_yaw), -L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw) - L4 * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) - L4 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch), sin(computed_joint_angles.hip_roll) * (sin(computed_joint_angles.hip_yaw) * (L1 - L1 * cos(computed_joint_angles.hip_roll) + L2 * sin(computed_joint_angles.hip_roll)) - L1 * sin(computed_joint_angles.hip_yaw) + (cos(computed_joint_angles.knee_pitch) - 1) * (cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll)) * (L2 + L4) + L2 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) * (L2 + L4) + L2 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * (cos(computed_joint_angles.hip_pitch) - 1)) - (L2 + L4 + L5) * (cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) * sin(computed_joint_angles.hip_yaw) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.knee_pitch) + cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.knee_pitch) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) - cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw) * (L2 - L1 * sin(computed_joint_angles.hip_roll) + L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) - L2 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) - L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) + L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + L4 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch)),
                      L1, -L2 * sin(computed_joint_angles.hip_yaw), L1 * sin(computed_joint_angles.hip_roll) - L2 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll), L1 * sin(computed_joint_angles.hip_roll) - L2 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll) - L4 * cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) + L4 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch), -(cos(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) - sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) - sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll))) * (L2 + L4 + L5) - sin(computed_joint_angles.hip_roll) * (L1 * cos(computed_joint_angles.hip_yaw) - L1 - cos(computed_joint_angles.hip_yaw) * (L1 - L1 * cos(computed_joint_angles.hip_roll) + L2 * sin(computed_joint_angles.hip_roll)) + (cos(computed_joint_angles.knee_pitch) - 1) * (sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) - cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_roll)) * (L2 + L4) + L2 * sin(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_pitch) + sin(computed_joint_angles.knee_pitch) * (cos(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.hip_yaw) + cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch)) * (L2 + L4) - L2 * cos(computed_joint_angles.hip_yaw) * sin(computed_joint_angles.hip_roll) * (cos(computed_joint_angles.hip_pitch) - 1)) - cos(computed_joint_angles.hip_yaw) * cos(computed_joint_angles.hip_roll) * (L2 - L1 * sin(computed_joint_angles.hip_roll) + L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) - L2 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) - L4 * cos(computed_joint_angles.hip_roll) * cos(computed_joint_angles.hip_pitch) * cos(computed_joint_angles.knee_pitch) + L2 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch) + L4 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_pitch) * sin(computed_joint_angles.knee_pitch)),
                      0, L1 * cos(computed_joint_angles.hip_yaw), -L1 * cos(computed_joint_angles.hip_roll) * sin(computed_joint_angles.hip_yaw), -cos(computed_joint_angles.hip_roll) * (L1 * sin(computed_joint_angles.hip_yaw) + L4 * sin(computed_joint_angles.hip_pitch)), -cos(computed_joint_angles.hip_roll) * (L5 * sin(computed_joint_angles.hip_pitch + computed_joint_angles.knee_pitch) + L1 * sin(computed_joint_angles.hip_yaw) + L4 * sin(computed_joint_angles.hip_pitch));
                  break;
            }

            // SR Inverse using Levenberg-Marquardt method solved using llt decomposition as in this Ax = b, A is symmetric and positive definite
            delta_joint_angles = (Jacobian.transpose() * Jacobian + LAMBDA * Eigen::MatrixXd::Identity(5, 5)).llt().solve(Jacobian.transpose() * Vb);

            // Update the joint angles
            computed_joint_angles.hip_yaw += delta_joint_angles(0);
            computed_joint_angles.hip_roll += delta_joint_angles(1);
            computed_joint_angles.hip_pitch += delta_joint_angles(2);
            computed_joint_angles.knee_pitch += delta_joint_angles(3);
            computed_joint_angles.ankle_pitch += delta_joint_angles(4);

            // Recompute the foot transformation matrix
            Tbf = computeFootFK(computed_joint_angles, leg_id); // Transformation matrix from base frame to current foot frame
            Tfd = trans_inv(Tbf) * Tbd;                         // Transformation matrix from current foot frame to desired foot frame
            Vf = skew_to_twist(Tfd.log());                      // Twist vector from current foot frame to desired foot frame
            Vb = trans_to_adj(Tbf) * Vf;                        // Twist vector from base frame to desired foot frame
            epsilon_w = Vb.head(3).norm();                      // Error tolerance for angular velocity w
            epsilon_v = Vb.tail(3).norm();                      // Error tolerance for linear velocity v

            iteration_count++; // Increment the iteration count
      }

      std::cout << "Number of iterations: " << iteration_count << std::endl;

      return computed_joint_angles;
}
